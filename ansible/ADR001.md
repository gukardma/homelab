# S3 Backend Bucket Deployment Method for Terraform

Status: `Accepted`

Date: `2025-10-22`

## Context and Problem Statement

As my homelab has expanded, managing services manually has become time consuming, error prone, and difficult to reproduce. To resolve this, I use Terraform, an Infrastructure as Code (IaC) tool, to define my entire infrastructure, including Proxmox VMs, containers, and network configurations.

A good practice for Terraform is to use a remote backend to store the state file (`terraform.tfstate`). This is necessary for preventing state loss and maintaining consistent deployments. In my case, a locally hosted MinIO server provides an S3 backend for Terraform.

But there is a problem:
1. My main Terraform configuration is set to use an S3 bucket in MinIO as its backend.
2. Terraform cannot run `terraform init` to initialize this backend because the bucket doesn't exist yet.
3. I want to use IaC to create the bucket, but Terraform can't run to do this

I need to find a reliable, automated, and reproducible method to deploy the initial bucket before the main Terraform project can use it.

## Decision Drivers

* The solution should use IaC making it reproducible and version controlled.
* Chosen method shouldn't depend on the main Terraform project's state (what I want to store).
* The bucket's configuration should be manageable over time.

## Considered Options

* **Manual:** Deploy with the MinIO web UI or CLI.
* **Stateful:** Use a small Terraform module/project to bootstrap the initial storage bucket, and store the bootstrapper state file locally.
* **Stateless:** Use a Ansible to validate and deploy the bucket.

## Pros and Cons of the Options

### Option 1: Manual Deployment
**Pros:** 
* Avoids circular dependency.
* Least complexity of all options, only requires an understanding of the MinIO UI or CLI.

**Cons:**
* Is not inherently version controlled in the same way as Terraform.
* Potential for human error (forgetting to version bucket, etc.).
* Requires scripts to automate.

### Option 2: Terraform Bootstrap

**Pros:**
* Builds on the main Terraform project and does not add the complexity of new tools.

**Cons:**
* Requires two step deployment process: Bootstrap Terraform initial storage, then run main Terraform project using the newly.
* The bootstrapper state file is stored locally.
* Terraform may react arbitrarily in the event of state loss.

### Option 3: Ansible Deployment

**Pros:**
* Ansible can deploy infrastructure similarly to Terraform, and configurations can be stored on github.
* Ansible is stateless and does not suffer from the circular dependency problem Terraform may have.

**Cons:**
* Addition of new tool adds complexity to the workflow (although a good learning experience).
* Due to stateless nature, will have to setup guardrails to prevent repeat configurations.

## Decision Outcome

Chosen option: **"Ansible Deployment"**, because it has the best balance of practicality and IaC principles.

This approach keeps the infrastructure defined as code. While it introduces a new tool, Ansible, it resolves the circular dependency without the added complexity of managing a separate local Terraform state. This allows the main Terraform project without circular dependencies.

## Links

* [Terraform Backend Documentation](https://developer.hashicorp.com/terraform/language/backend)
* [Terraform MinIO Provider](https://github.com/aminueza/terraform-provider-minio)